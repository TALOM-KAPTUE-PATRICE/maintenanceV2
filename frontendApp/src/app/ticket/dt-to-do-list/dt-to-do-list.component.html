<mat-card class="dt-to-do-list-card mb-25 border-radius d-block bg-white border-0 shadow-none">
  <mat-card-header>
    <mat-card-title>
      <h5>Liste des Projets (Tickets)</h5>
    </mat-card-title>
    <div class="d-flex align-items-center">
      <form class="search-box position-relative me-3">
        <i class="material-icons">search</i>
        <input type="text" class="input-search" placeholder="Filtrer les résultats..." (keyup)="applyFilter($event)">
      </form>
      <button class="add-new-task-btn" type="button" mat-button (click)="openForm()">
        <i class="material-icons">add</i>
        Nouveau Projet
      </button>
    </div>
  </mat-card-header>

  <mat-card-content>
    <div *ngIf="isLoading" class="loading-shade">
      <mat-spinner></mat-spinner>
    </div>

    <div class="table-responsive">
      <table mat-table [dataSource]="dataSource" class="mat-elevation-z8">

        <ng-container matColumnDef="id">
          <th mat-header-cell *matHeaderCellDef>ID</th>
          <td mat-cell *matCellDef="let element">{{element.id}}</td>
        </ng-container>

        <ng-container matColumnDef="titre">
          <th mat-header-cell *matHeaderCellDef>Titre du Projet</th>
          <td mat-cell *matCellDef="let element">{{element.titre}}</td>
        </ng-container>

        <ng-container matColumnDef="statut">
          <th mat-header-cell *matHeaderCellDef>Statut</th>
          <td mat-cell *matCellDef="let element"><span class="badge"
              [ngClass]="'status-' + element.statut.toLowerCase()">{{element.statut}}</span></td>
        </ng-container>

        <ng-container matColumnDef="avancement">
          <th mat-header-cell *matHeaderCellDef>Avancement</th>
          <td mat-cell *matCellDef="let element">{{element.avancementPourcentage}}%</td>
        </ng-container>

        <ng-container matColumnDef="userNom">
          <th mat-header-cell *matHeaderCellDef>Assigné à</th>
          <td mat-cell *matCellDef="let element">{{element.userNom}}</td>
        </ng-container>

        <ng-container matColumnDef="clientNom">
          <th mat-header-cell *matHeaderCellDef>Client</th>
          <td mat-cell *matCellDef="let element">{{element.clientNom}}</td>
        </ng-container>

        <ng-container matColumnDef="dateCreation">
          <th mat-header-cell *matHeaderCellDef>Date de création</th>
          <td mat-cell *matCellDef="let element">{{element.dateCreation | date:'dd/MM/yyyy HH:mm'}}</td>
        </ng-container>

        <ng-container matColumnDef="action">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let element">
            <button mat-icon-button (click)="onViewDetails(element)" matTooltip="Voir les détails">
              <i class="material-icons">visibility</i>
            </button>
            <button mat-icon-button (click)="openForm(element)" matTooltip="Modifier">
              <i class="material-icons">edit</i>
            </button>
            <button mat-icon-button (click)="onPrint(element.id)" matTooltip="Imprimer la fiche">
              <i class="material-icons">print</i>
            </button>
            <button mat-icon-button color="warn" (click)="onDelete(element.id)" matTooltip="Supprimer">
              <i class="material-icons">delete</i>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

        <tr class="mat-row" *matNoDataRow>
          <td class="mat-cell" colspan="8" *ngIf="!isLoading">Aucun projet trouvé.</td>
        </tr>
      </table>
    </div>

    <mat-paginator [length]="totalElements" [pageSizeOptions]="[5, 10, 20]" showFirstLastButtons></mat-paginator>
  </mat-card-content>
</mat-card>

<!-- Formulaire Popup/Overlay -->
<div class="add-new-popup" [class.active]="isFormVisible">
  <div class="popup-dialog">
    <mat-card class="border-radius d-block bg-white border-0 shadow-none">
      <mat-card-header>
        <mat-card-title>{{ isEditing ? 'Modifier' : 'Ajouter' }} un Projet</mat-card-title>
        <button mat-icon-button (click)="closeForm()" class="close-btn"><i class="material-icons">close</i></button>
      </mat-card-header>
      <mat-card-content>
        <form [formGroup]="ticketForm" (ngSubmit)="onSubmit()">

          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Titre du Projet</mat-label>
            <input matInput formControlName="titre" required>
            <mat-error *ngIf="ticketForm.get('titre')?.hasError('required')">Le titre est obligatoire.</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Description détaillée</mat-label>
            <textarea matInput formControlName="description" rows="5" required></textarea>
            <mat-error *ngIf="ticketForm.get('description')?.hasError('required')">La description est
              obligatoire.</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Client</mat-label>
            <mat-select formControlName="clientId" required>
              <mat-option *ngFor="let client of clients" [value]="client.id">{{client.nom}}</mat-option>
            </mat-select>
            <mat-error *ngIf="ticketForm.get('clientId')?.hasError('required')">Le client est obligatoire.</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Assigné à (Utilisateur)</mat-label>
            <mat-select formControlName="userId" required>
              <mat-option *ngFor="let user of users" [value]="user.id">{{user.nom}}</mat-option>
            </mat-select>
            <mat-error *ngIf="ticketForm.get('userId')?.hasError('required')">L'utilisateur est obligatoire.</mat-error>
          </mat-form-field>

          <div class="btn-box text-end">
            <button mat-stroked-button (click)="closeForm()" type="button">Annuler</button>
            <button mat-flat-button color="primary" type="submit" [disabled]="ticketForm.invalid || isLoading">
              <span *ngIf="!isLoading">{{ isEditing ? 'Modifier' : 'Enregistrer' }}</span>
              <span *ngIf="isLoading">Enregistrement...</span>
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>
  </div>
</div>