<mat-card class="dt-to-do-list-card mb-25 border-radius d-block bg-white border-0 shadow-none"
  [class.component-rtl-enabled]="themeService.isRTLEnabled()">

<mat-card-header>
    <mat-card-title>
      <h5>Gestion des Devis</h5>
    </mat-card-title>
    <div class="d-flex align-items-center">
      <button mat-flat-button color="primary" (click)="openForm()">
          <mat-icon>add</mat-icon> Nouveau Devis
      </button>
    </div>
  </mat-card-header>

  <mat-card-content>
    <div *ngIf="isLoading" class="loading-shade"><mat-spinner ></mat-spinner></div>
    <div class="table-responsive">
      <table mat-table [dataSource]="dataSource">
        
        <ng-container matColumnDef="id">
          <th mat-header-cell *matHeaderCellDef> Réf. Devis </th>
          <td mat-cell *matCellDef="let element"> {{element.id}} </td>
        </ng-container>

        <ng-container matColumnDef="statut">
            <th mat-header-cell *matHeaderCellDef> Statut </th>
            <td mat-cell *matCellDef="let element">
                <span class = "badge" [ngClass]="'status-devis-' + element.statut.toLowerCase()">{{ element.statut | titlecase }}</span>
            </td>
        </ng-container>
        
        <ng-container matColumnDef="description">
          <th mat-header-cell *matHeaderCellDef> Description </th>
          <td mat-cell *matCellDef="let element" class="description-cell"> {{element.description}} </td>
        </ng-container>

        <ng-container matColumnDef="clientNom">
            <th mat-header-cell *matHeaderCellDef> Email Client </th>
            <td mat-cell *matCellDef="let element"> {{element.client || 'N/A'}} </td>
        </ng-container>
        
        <ng-container matColumnDef="dateCreation">
          <th mat-header-cell *matHeaderCellDef> Créé le </th>
          <td mat-cell *matCellDef="let element"> {{element.dateCreation | date:'dd/MM/yyyy'}} </td>
        </ng-container>

        <ng-container matColumnDef="dateValidite">
          <th mat-header-cell *matHeaderCellDef> Valide jusqu'au </th>
          <td mat-cell *matCellDef="let element"> {{element.dateValidite | date:'dd/MM/yyyy'}} </td>
        </ng-container>

        <ng-container matColumnDef="action">
          <th mat-header-cell *matHeaderCellDef> Actions </th>
          <td mat-cell *matCellDef="let element">
            <button mat-icon-button (click)="onViewDetails(element)" matTooltip="Voir les détails"><mat-icon>visibility</mat-icon></button>
            <button mat-icon-button (click)="openForm(element)" matTooltip="Modifier"><mat-icon>edit</mat-icon></button>
            <button mat-icon-button (click)="onPrint(element.id)" matTooltip="Imprimer"><mat-icon>print</mat-icon></button>
            <!-- Gérer l'ajout d'articles -->
            <button mat-icon-button color="accent" (click)="onManageArticles(element.id)" matTooltip="Gérer les articles"><mat-icon>playlist_add</mat-icon></button>
            <button mat-icon-button color="warn" (click)="onDelete(element.id)" matTooltip="Supprimer"><mat-icon>delete</mat-icon></button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        <tr class="mat-row" *matNoDataRow><td class="mat-cell" colspan="7">Aucun devis à afficher.</td></tr>
      </table>
    </div>
    <mat-paginator [pageSizeOptions]="[5, 15, 25]" showFirstLastButtons></mat-paginator>
  </mat-card-content>
</mat-card>

<!-- Formulaire Popup -->
<div class="add-new-popup" [class.active]="isFormVisible">
  <div class="popup-dialog">
    <mat-card>
      <mat-card-header>
        <mat-card-title>{{ isEditing ? 'Modifier le' : 'Créer un' }} Devis</mat-card-title>
        <button mat-icon-button (click)="closeForm()" class="close-btn"><mat-icon>close</mat-icon></button>
      </mat-card-header>
      <mat-card-content>
        <form [formGroup]="devisForm" (ngSubmit)="onSubmit()">
          
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Client</mat-label>
            <mat-select formControlName="clientId" required>
              <mat-option *ngFor="let client of clients" [value]="client.id">{{ client.nom }}</mat-option>
            </mat-select>
            <mat-error *ngIf="devisForm.get('clientId')?.hasError('required')">Le client est obligatoire.</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Description / Objet du devis</mat-label>
            <textarea matInput formControlName="description" rows="3" required></textarea>
            <mat-error *ngIf="devisForm.get('description')?.hasError('required')">La description est obligatoire.</mat-error>
          </mat-form-field>

          <div class="row">
            <div class="col-md-6">
              <mat-form-field appearance="outline" class="w-100">
                <mat-label>Date de validité</mat-label>
                <input matInput [matDatepicker]="picker" formControlName="dateValidite" required>
                <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                <mat-datepicker #picker></mat-datepicker>
                <mat-error *ngIf="devisForm.get('dateValidite')?.hasError('required')">La date est obligatoire.</mat-error>
              </mat-form-field>
            </div>
            <div class="col-md-6">
              <mat-form-field appearance="outline" class="w-100">
                <mat-label>Devise</mat-label>
                <input matInput formControlName="devise" required>
                <mat-error *ngIf="devisForm.get('devise')?.hasError('required')">La devise est obligatoire.</mat-error>
              </mat-form-field>
            </div>
          </div>

          <!-- Section optionnelle -->
          <mat-expansion-panel>
            <mat-expansion-panel-header>
                <mat-panel-title>Détails supplémentaires (Optionnel)</mat-panel-title>
            </mat-expansion-panel-header>
            <div class="row pt-3">
              <div class="col-md-6"><mat-form-field appearance="outline" class="w-100"><mat-label>Type de travaux</mat-label><input matInput formControlName="typeTravaux"></mat-form-field></div>
              <div class="col-md-6"><mat-form-field appearance="outline" class="w-100"><mat-label>Site d'intervention</mat-label><input matInput formControlName="siteIntervention"></mat-form-field></div>
              <div class="col-md-6"><mat-form-field appearance="outline" class="w-100"><mat-label>Contraintes</mat-label><input matInput formControlName="contrainte"></mat-form-field></div>
              <div class="col-md-6"><mat-form-field appearance="outline" class="w-100"><mat-label>Livraison</mat-label><input matInput formControlName="livraison"></mat-form-field></div>
              <div class="col-md-6"><mat-form-field appearance="outline" class="w-100"><mat-label>Effectif nécessaire</mat-label><input matInput type="number" formControlName="effectif" required></mat-form-field></div>
              <div class="col-md-6 pt-3"><mat-checkbox formControlName="peinture" color="primary">Prestation de peinture incluse</mat-checkbox></div>
            </div>
          </mat-expansion-panel>

          <div class="btn-box text-end mt-4">
            <button mat-stroked-button (click)="closeForm()" type="button">Annuler</button>
            <button mat-flat-button color="primary" type="submit" [disabled]="devisForm.invalid || isLoading">
                <span *ngIf="!isLoading">{{ isEditing ? 'Enregistrer les modifications' : 'Créer le Devis' }}</span>
                <span *ngIf="isLoading">Enregistrement...</span>
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>
  </div>
</div>