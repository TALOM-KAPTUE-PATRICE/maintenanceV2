<mat-card class="dt-card mb-25 border-radius d-block bg-white border-0 shadow-none">
  <mat-card-header>
    <mat-card-title>Bons de Commande Clients</mat-card-title>
    <div class="d-flex align-items-center">
      <form class="search-box me-3">
        <mat-icon>search</mat-icon>
        <input type="text" (keyup)="applyFilter($event)" placeholder="Rechercher...">
      </form>
      <button mat-flat-button color="primary" (click)="openForm()">
        <mat-icon>add</mat-icon> Enregistrer un BC Client
      </button>
    </div>
  </mat-card-header>
  
  <mat-card-content>
    <div *ngIf="isLoading" class="loading-shade"><mat-spinner></mat-spinner></div>
    <div class="table-responsive">
      <table mat-table [dataSource]="dataSource">
        
        <ng-container matColumnDef="referenceClient">
          <th mat-header-cell *matHeaderCellDef>Réf. Client</th>
          <td mat-cell *matCellDef="let bcc">{{bcc.referenceClient}}</td>
        </ng-container>

        <ng-container matColumnDef="dateReception">
          <th mat-header-cell *matHeaderCellDef>Date Réception</th>
          <td mat-cell *matCellDef="let bcc">{{bcc.dateReception | date:'dd/MM/yyyy'}}</td>
        </ng-container>

        <ng-container matColumnDef="clientNom">
          <th mat-header-cell *matHeaderCellDef>Client</th>
          <td mat-cell *matCellDef="let bcc">{{bcc.clientNom}}</td>
        </ng-container>
        
        <ng-container matColumnDef="devisId">
          <th mat-header-cell *matHeaderCellDef>Réf. Devis Validé</th>
          <td mat-cell *matCellDef="let bcc">{{bcc.devisId}}</td>
        </ng-container>
        
        <ng-container matColumnDef="action">
          <th mat-header-cell *matHeaderCellDef class="text-end">Actions</th>
          <td mat-cell *matCellDef="let bcc" class="text-end">
            <button mat-icon-button color="accent" (click)="viewPdf(bcc.pdfUrl)" matTooltip="Voir le PDF">
              <mat-icon>picture_as_pdf</mat-icon>
            </button>
            <button mat-icon-button color="warn" (click)="onDelete(bcc.id)" matTooltip="Supprimer">
              <mat-icon>delete</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        <tr *matNoDataRow><td colspan="5">Aucun bon de commande client enregistré.</td></tr>
      </table>
    </div>
    <mat-paginator [pageSizeOptions]="[10, 25]" showFirstLastButtons></mat-paginator>
  </mat-card-content>
</mat-card>

<!-- Formulaire Popup -->
<div class="add-new-popup" [class.active]="isFormVisible">
  <div class="popup-dialog">
    <mat-card>
      <mat-card-header>
        <mat-card-title>Enregistrer un Bon de Commande Client</mat-card-title>
        <button mat-icon-button (click)="closeForm()" class="close-btn"><mat-icon>close</mat-icon></button>
      </mat-card-header>
      <mat-card-content>
        <form [formGroup]="bccForm" (ngSubmit)="onSubmit()">
          
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Devis à valider</mat-label>
            <mat-select formControlName="devisId" required>
              <mat-option *ngFor="let devis of devisList" [value]="devis.id">{{ devis.id }} - {{ devis.description | slice:0:40 }}...</mat-option>
            </mat-select>
            <mat-error>Le devis est obligatoire.</mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Référence du BC Client (ex: PO-SABC-123)</mat-label>
            <input matInput formControlName="referenceClient" required>
            <mat-error>La référence est obligatoire.</mat-error>
          </mat-form-field>
          
          <mat-form-field appearance="outline" class="w-100">
            <mat-label>Date de réception</mat-label>
            <input matInput [matDatepicker]="picker" formControlName="dateReception" required>
            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
            <mat-error>La date est obligatoire.</mat-error>
          </mat-form-field>

          <div class="file-upload-container">
            <button type="button" mat-stroked-button (click)="fileInput.click()">
              <mat-icon>attach_file</mat-icon>
              <span>Charger le PDF du Bon de Commande</span>
            </button>
            <input hidden type="file" #fileInput (change)="onFileSelected($event)" accept=".pdf">
            <span *ngIf="selectedFile" class="file-name">{{ selectedFile.name }}</span>
            <mat-error *ngIf="bccForm.get('pdfFile')?.hasError('required') && bccForm.get('pdfFile')?.touched">Le fichier PDF est obligatoire.</mat-error>
          </div>

          <mat-form-field appearance="outline" class="w-100 mt-3">
            <mat-label>Notes (optionnel)</mat-label>
            <textarea matInput formControlName="notes" rows="3"></textarea>
          </mat-form-field>
          
          <div class="btn-box text-end mt-3">
            <button mat-stroked-button type="button" (click)="closeForm()" class="me-2">Annuler</button>
            <button mat-flat-button color="primary" type="submit" [disabled]="bccForm.invalid || isLoading">
              <span *ngIf="!isLoading">Enregistrer</span>
              <mat-progress-spinner *ngIf="isLoading" diameter="20" mode="indeterminate"></mat-progress-spinner>
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>
  </div>
</div>